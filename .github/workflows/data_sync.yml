name: Data Sync Workflows

on:
  # æ¯æ—¥è‡ªåŠ¨ä»»åŠ¡ (æ—¶é—´å¯ä»¥æå‰ï¼Œä¾‹å¦‚åœ¨åŒ—äº¬æ—¶é—´ä¸‹åˆ4ç‚¹åŠ)
  schedule:
    - cron: '30 8 * * *' # æ¯å¤© UTC æ—¶é—´ 8:30 (åŒ—äº¬æ—¶é—´ä¸‹åˆ 4:30) è¿è¡Œ

  # æ‰‹åŠ¨ä»»åŠ¡
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'é€‰æ‹©åŒæ­¥æ¨¡å¼'
        required: true
        default: 'daily'
        type: choice
        options:
          - full
          - partial
          - daily
          - verify # æ–°å¢æ‰‹åŠ¨æ ¡éªŒé€‰é¡¹

jobs:
  # Job 1: æ‰§è¡Œä¸»è¦çš„åŒæ­¥ä»»åŠ¡
  run-main-sync:
    runs-on: ubuntu-latest
    outputs:
      # è¾“å‡ºæ‰‹åŠ¨è§¦å‘æ—¶é€‰æ‹©çš„æ¨¡å¼ï¼Œä»¥ä¾¿æ ¡éªŒä»»åŠ¡å¯ä»¥è·³è¿‡
      dispatch_mode: ${{ github.event.inputs.sync_mode }}
    steps:
      - name: ğŸš€ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install akshare pandas supabase "concurrent-log-handler<1"

      - name: ğŸƒ Run main data sync script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œåˆ™ä½¿ç”¨è¾“å…¥çš„æ¨¡å¼
          # å¦‚æœæ˜¯å®šæ—¶ä»»åŠ¡(schedule)ï¼Œåˆ™é»˜è®¤ä¸º daily
          MODE=${{ github.event.inputs.sync_mode || 'daily' }}
          echo "Running main sync with mode: $MODE"
          python sync_data.py $MODE

  # Job 2: ä¸“é—¨ç”¨äºæ ¡éªŒå’Œä¿®å¤æ•°æ®
  run-verification-job:
    runs-on: ubuntu-latest
    # `needs` ç¡®ä¿è¿™ä¸ª job åœ¨ä¸Šä¸€ä¸ª job ç»“æŸåè¿è¡Œ
    needs: run-main-sync
    # `if: always()` ç¡®ä¿æ— è®ºä¸Šä¸€ä¸ª job æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œè¿™ä¸ª job éƒ½ä¼šè¿è¡Œ
    # ä½†æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›åœ¨æ‰‹åŠ¨è¿è¡Œ full æˆ– partial æ—¶ä¹Ÿæ ¡éªŒï¼Œå› ä¸ºé‚£æ²¡æ„ä¹‰
    if: always() && needs.run-main-sync.outputs.dispatch_mode != 'full' && needs.run-main-sync.outputs.dispatch_mode != 'partial'
    
    steps:
      - name: ğŸš€ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install akshare pandas supabase "concurrent-log-handler<1"
          
      - name: â³ Add a delay before verification
        # åœ¨ä¸»ä»»åŠ¡å’Œæ ¡éªŒä»»åŠ¡ä¹‹é—´å¢åŠ ä¸€ä¸ªå»¶è¿Ÿï¼ˆä¾‹å¦‚5åˆ†é’Ÿï¼‰
        # è¿™å¯ä»¥ç­‰å¾…APIæœåŠ¡å™¨è§£é™¤å¯¹æ‚¨IPçš„ä¸´æ—¶é™åˆ¶
        run: echo "Waiting 5 minutes for API rate limits to cool down..." && sleep 300

      - name: ğŸ•µï¸ Run verification and retry script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "Running verification and retry job..."
          python sync_data.py verify
