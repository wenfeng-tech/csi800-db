name: Data Sync Workflows

on:
  schedule:
    - cron: '30 8 * * *' # 每天 UTC 时间 8:30 (北京时间下午 4:30) 运行

  workflow_dispatch:
    inputs:
      sync_mode:
        description: '选择同步模式'
        required: true
        default: 'daily'
        type: choice
        options:
          - full
          - partial
          - daily
          - verify

jobs:
  run-main-sync:
    runs-on: ubuntu-latest
    outputs:
      dispatch_mode: ${{ github.event.inputs.sync_mode }}
    steps:
      - name: 🚀 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 优化: 缓存pip依赖项
      - name: 📥 Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          # 建议创建一个 requirements.txt 文件包含以下内容
          # akshare
          # pandas
          # supabase
          # "concurrent-log-handler<1"
          # tenacity
          pip install akshare pandas supabase "concurrent-log-handler<1" tenacity

      - name: 🏃 Run main data sync script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          MODE=${{ github.event.inputs.sync_mode || 'daily' }}
          echo "Running main sync with mode: $MODE"
          python sync_data.py $MODE

  run-verification-job:
    runs-on: ubuntu-latest
    needs: run-main-sync
    # 优化: 增加对 verify 模式的判断，避免手动触发时重复执行
    if: always() && needs.run-main-sync.outputs.dispatch_mode != 'full' && needs.run-main-sync.outputs.dispatch_mode != 'partial' && needs.run-main-sync.outputs.dispatch_mode != 'verify'

    steps:
      - name: 🚀 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 优化: 缓存pip依赖项
      - name: 📥 Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install akshare pandas supabase "concurrent-log-handler<1" tenacity

      - name: ⏳ Add a delay before verification
        run: echo "Waiting 5 minutes for API rate limits to cool down..." && sleep 300

      - name: 🕵️ Run verification and retry script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "Running verification and retry job..."
          python sync_data.py verify
