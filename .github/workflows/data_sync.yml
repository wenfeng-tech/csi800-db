name: Data Sync Workflows

on:
  schedule:
    - cron: '30 8 * * *' # æ¯å¤© UTC æ—¶é—´ 8:30 (åŒ—äº¬æ—¶é—´ä¸‹åˆ 4:30) è¿è¡Œ

  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'é€‰æ‹©åŒæ­¥æ¨¡å¼'
        required: true
        default: 'daily'
        type: choice
        options:
          - full
          - partial
          - daily
          - verify

jobs:
  run-main-sync:
    runs-on: ubuntu-latest
    outputs:
      dispatch_mode: ${{ github.event.inputs.sync_mode }}
    steps:
      - name: ğŸš€ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ä¼˜åŒ–: ç¼“å­˜pipä¾èµ–é¡¹
      - name: ğŸ“¥ Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å»ºè®®åˆ›å»ºä¸€ä¸ª requirements.txt æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹
          # akshare
          # pandas
          # supabase
          # "concurrent-log-handler<1"
          # tenacity
          pip install akshare pandas supabase "concurrent-log-handler<1" tenacity

      - name: ğŸƒ Run main data sync script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          MODE=${{ github.event.inputs.sync_mode || 'daily' }}
          echo "Running main sync with mode: $MODE"
          python sync_data.py $MODE

  run-verification-job:
    runs-on: ubuntu-latest
    needs: run-main-sync
    # ä¼˜åŒ–: å¢åŠ å¯¹ verify æ¨¡å¼çš„åˆ¤æ–­ï¼Œé¿å…æ‰‹åŠ¨è§¦å‘æ—¶é‡å¤æ‰§è¡Œ
    if: always() && needs.run-main-sync.outputs.dispatch_mode != 'full' && needs.run-main-sync.outputs.dispatch_mode != 'partial' && needs.run-main-sync.outputs.dispatch_mode != 'verify'

    steps:
      - name: ğŸš€ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ä¼˜åŒ–: ç¼“å­˜pipä¾èµ–é¡¹
      - name: ğŸ“¥ Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install akshare pandas supabase "concurrent-log-handler<1" tenacity

      - name: â³ Add a delay before verification
        run: echo "Waiting 5 minutes for API rate limits to cool down..." && sleep 300

      - name: ğŸ•µï¸ Run verification and retry script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "Running verification and retry job..."
          python sync_data.py verify
