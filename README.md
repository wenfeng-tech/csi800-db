# 🚀 高效健壮的中证800数据同步工具 (v2.0)

这是一个经过全面优化的、基于 GitHub Actions 的自动化工作流，用于定期抓取中证800（000906）所有成分股的日线交易数据，并将其同步到您的 **Supabase** 数据库中。

新版本引入了**并发处理**和**两阶段同步**机制，极大地提升了数据同步的**速度**和**可靠性**，能够有效应对API访问限制，确保数据完整性。

## ✨ 核心优势

  - **⚡ 高效并发处理**: 利用多线程技术同时获取多只股票的数据，同步速度相比旧版有数倍提升。
  - **🛡️ 健壮的两阶段同步**:
    1.  **主任务**: 每日高速执行一次数据同步。
    2.  **校验任务**: 在主任务完成后自动运行，识别并**重新同步**失败或遗漏的股票，有效解决了因API限制导致的数据中断问题。
  - **📦 批量数据插入**: 将所有获取到的数据聚合后一次性写入数据库，极大降低了数据库的I/O压力，提高了插入效率。
  - **🤖 全自动化运行**: 利用 GitHub Actions 定时任务，每日自动执行“主同步 + 校验修复”的完整流程，无需人工干预。
  - **🕹️ 灵活的手动控制**: 提供统一的工作流入口，可通过菜单选择不同的同步模式（全量、增量、仅校验等），满足不同场景的需求。
  - **🔧 开箱即用**: 只需简单配置Supabase密钥和数据库表，即可开始使用。

## 🔧 如何使用

### 1\. 配置 GitHub Secrets

为了安全地连接到你的 Supabase 数据库，你需要在 GitHub 仓库中配置以下两个 Secrets。

  - 进入你的 GitHub 仓库主页。
  - 点击 **Settings** -\> **Secrets and variables** -\> **Actions**。
  - 点击 **New repository secret**，分别添加以下两项：
      - **`SUPABASE_URL`**：你的 Supabase 项目 URL。
      - **`SUPABASE_KEY`**：你的 Supabase 服务角色密钥（`service_role key`），脚本需要写入和更新权限。

### 2\. 设置 Supabase 数据库

在你的 Supabase 项目中，你需要创建一个名为 `csi800_daily_data` 的数据表。

**表名：** `csi800_daily_data`

**推荐的列及其数据类型：**

| 列名         | 数据类型  | 描述                 |
| :----------- | :-------- | :------------------- |
| `trade_date` | `date`    | 交易日期             |
| `stock_code` | `text`    | 股票代码             |
| `stock_name` | `text`    | 股票名称             |
| `open`       | `numeric` | 开盘价               |
| `high`       | `numeric` | 最高价               |
| `low`        | `numeric` | 最低价               |
| `close`      | `numeric` | 收盘价               |
| `volume`     | `numeric` | 成交量               |

**⚠️ 重要：设置主键**

为了让 `upsert` (更新或插入) 操作能够正确工作，防止数据重复，你**必须**为 `trade_date` 和 `stock_code` 设置一个复合主键。

你可以在 Supabase SQL Editor 中运行以下命令来设置：

```sql
ALTER TABLE public.csi800_daily_data
ADD PRIMARY KEY (trade_date, stock_code);
```

## 🏃‍♀️ 运行工作流

新版工作流将所有任务整合到了一个名为 `Data Sync Workflows` 的文件中，你可以通过自动或手动方式触发。

### 自动每日同步 (默认)

  - 工作流被设置为在北京时间每天下午 `16:30` 自动运行。
  - 它会自动执行两阶段同步：
    1.  首先运行 `run-main-sync` 作业，以 `daily` 模式高速同步最近5天的数据。
    2.  无论上一个作业是否完全成功，`run-verification-job` 作业都会在其结束后运行。它会等待5分钟（API冷却），然后以 `verify` 模式检查并修复任何数据落后或缺失的股票。

### 手动触发任务

你可以随时手动触发工作流来满足特定需求，例如进行一次全量历史数据同步。

1.  进入 GitHub 仓库的 **Actions** 页面。
2.  在左侧列表中选择 **Data Sync Workflows**。
3.  在右侧，你会看到一个 "Run workflow" 的下拉按钮。
4.  在 **“选择同步模式” (Select sync mode)** 下拉菜单中选择你想要的模式，然后点击绿色的 **Run workflow** 按钮。

**可用的手动模式：**

| 模式选项 (`sync_mode`) | 描述                                                              | 适用场景                               |
| :--------------------- | :---------------------------------------------------------------- | :------------------------------------- |
| `daily`                | **每日更新**: 同步所有成分股最近5天的交易数据。                   | 日常维护，或修复最近几天的数据。       |
| `partial`              | **部分历史同步**: 同步所有成分股自 **2015年** 以来的数据。          | 需要较长历史数据但又非全部的场景。     |
| `full`                 | **全量历史同步**: 同步所有成分股自 **2005年** 以来的全部历史数据。  | 首次初始化数据库。**注意：此过程耗时较长！** |
| `verify`               | **仅校验修复**: 检查数据库，并只同步数据缺失或落后的股票。        | 手动修复数据完整性问题。               |

-----

### ⚙️ 技术栈

  - **Python**：核心脚本语言
  - **akshare**：用于获取股票数据
  - **pandas**：用于数据处理和格式化
  - **supabase-py**：用于与 Supabase 数据库交互
  - **GitHub Actions**：自动化 CI/CD 工作流
